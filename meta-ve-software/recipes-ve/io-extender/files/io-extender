#! /bin/sh

set -e
R0_PINS="relay_1 2:in 5:set 6:res"
R1_PINS="relay_2 1:in 3:set 4:res"
SSR_PINS="ssr_3 0:"

ALL_PINS="0:1 1:2 2:3 3:4 11:5 12:6 13:7 14:8 8:g1 9:g0 15:pwm_en"
G0_PINS="9 0:1 1:2 2:3 3:4"
G1_PINS="8 11:5 12:6 13:7 14:8"
PWM_EN_PIN=15

setup_group() (
    gpio_base=$1
    shift 1

    direction=in
    label=io

    for pin; do
        p=${pin%:*}
        n=${pin#*:}
        gpio=$((gpio_base + p))
        echo $gpio >/sys/class/gpio/export
        echo $direction >/sys/class/gpio/gpio$gpio/direction
        link=$DIR/${label}_$n
        ln -s /sys/class/gpio/gpio$gpio $link
        echo "$label	$link $n" >>$CONF
    done
)

setup_relay() {
    gpio_base=$1
    label=$2
    shift 2

    for pin; do
        p=${pin%:*}
        n=${pin#*:}
        gpio=$((gpio_base + p))

        case $n in
            in) direction=in  ;;
            *)  direction=low ;;
        esac

        echo $gpio >/sys/class/gpio/export
        echo $direction >/sys/class/gpio/gpio$gpio/direction
        link=$DIR/$label${n:+_$n}
        ln -s /sys/class/gpio/gpio$gpio $link
    done

    link=$DIR/$label
    n=${label#*_}
    echo "relay	$link $n" >>$CONF

}

create_relay_script()
{
    n=$1
    file=$DIR/relay_$n.sh
    cat > $file <<-EOF
    #! /bin/sh
    if [ \$# -lt 1 ]; then
        echo \$(cat relay_${n}_in/value)
        exit 0
    fi
    n=\$1
    echo 0 > relay_${n}_res/value
    echo 0 > relay_${n}_set/value
    if [ "\$n" = 1 ]; then
        echo 1 > relay_${n}_set/value
    else
        echo 1 > relay_${n}_res/value
    fi
    sleep 0.5
    echo 0 > relay_${n}_res/value
    echo 0 > relay_${n}_set/value
    echo \$(cat relay_${n}_in/value)
EOF

    chmod +x $file
}

setup_dio() {
    dev=$(realpath /sys/$DEVPATH/../../../..)
    serial=$(cat $dev/serial)
    gpio_base=$(cat $dev/gpio/*/base)
    gpio_base_i2c=$(cat $dev/i2c-*/*-0020/gpio/*/base)

    setup_group $gpio_base_i2c $ALL_PINS
    setup_relay $gpio_base $R0_PINS
    setup_relay $gpio_base $R1_PINS
    setup_relay $gpio_base $SSR_PINS
    create_relay_script 1
    create_relay_script 2

    # PWM enable pin, set to output and set high
    gpio=$((gpio_base_i2c + PWM_EN_PIN))
    echo out >/sys/class/gpio/gpio$gpio/direction
    # Enable PWM by default
    echo 1 >/sys/class/gpio/gpio$gpio/value

    # Insert tag at the first line of the conf file.
    sed  -i "1i tag $serial" $CONF
}

setup_pwm() {
    path=$(realpath /sys/$DEVPATH)
    n=$(echo $NAME | cut -c 4)
    link=$DIR/pwm$n
    ln -s /sys/class/leds/$NAME/brightness $link

    echo "pwm	$link $(($n+1))" >>$CONF
}

case $ACTION in
    add)
        dev=$(realpath /sys/$DEVPATH/../../../..)
        serial=$(cat $dev/serial)
        DIR=/run/io-ext/$serial
        mkdir -p $DIR
        CONF=$DIR/pins.conf
        NAME=$1

        if [ "$SUBSYSTEM" == "gpio" ]; then
            setup_dio

            ln -sf $dev/serial $DIR/serial
            ln -sf $dev/manufacturer $DIR/manufacturer
            ln -sf $dev/product $DIR/product
            ln -sf $dev/max_power $DIR/max_power
            ln -sf $dev/product_id $DIR/product_id
            ln -sf $dev/vendor_id $DIR/vendor_id

            mkdir -p /dev/io-ext/
            ln -s $DIR /dev/io-ext
        elif [ "$SUBSYSTEM" == "leds" ]; then
            setup_pwm $NAME
        fi
        ;;
    remove)
        if [ "$HID_NAME" == "Victron Energy BV GX IO-Extender 150" ]; then
            DIR=/run/io-ext/$HID_UNIQ
            if [ -e "$DIR" ]; then
                rm -rf /dev/io-ext/$HID_UNIQ
                rm -rf "$DIR"
            fi
        fi
        ;;
esac